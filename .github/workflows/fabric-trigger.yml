
name: Trigger Fabric Pipeline

on:
  push:
    paths:
      - 'prompts/*.json'
  workflow_dispatch:
    inputs:
      json_path:
        description: 'Ruta del JSON a usar (opcional, p.ej. prompts/Test1.json)'
        required: false
        default: ''

jobs:
  run-fabric-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determinar el archivo JSON
        id: pick-file
        shell: bash
        run: |
          set -e

          FILE_INPUT="${{ github.event.inputs.json_path }}"
          if [ -n "$FILE_INPUT" ] && [ -f "$FILE_INPUT" ]; then
            FILE="$FILE_INPUT"
          else
            FILE=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E '^prompts/.*\.json$' | head -n 1 || true)
            if [ -z "$FILE" ]; then
              FILE=$(ls prompts/*.json | head -n 1 || true)
            fi
          fi

          if [ -z "$FILE" ] || [ ! -f "$FILE" ]; then
            echo "No se encontró un archivo JSON válido en prompts/"; exit 1
          fi

          echo "Usando archivo: $FILE"
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Validar JSON
        id: validate-json
        shell: bash
        run: |
          set -e
          FILE="${{ steps.pick-file.outputs.file }}"
          echo "Validando: $FILE"
          jq . "$FILE" > /dev/null

      - name: Obtener token Azure AD
        id: token
        shell: bash
        run: |
          set -e

          RESP=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${{ secrets.AZURE_CLIENT_ID }}&scope=https%3A%2F%2Fapi.fabric.microsoft.com%2F.default&client_secret=${{ secrets.AZURE_CLIENT_SECRET }}&grant_type=client_credentials" \
            "https://login.microsoftonline.com/${{ secrets.AZURE_TENANT_ID }}/oauth2/v2.0/token")

          echo "$RESP" | jq . > /dev/null || { echo "Respuesta inválida al solicitar token"; echo "$RESP"; exit 1; }

          TOKEN=$(echo "$RESP" | jq -r .access_token)
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "No se obtuvo access_token"; exit 1
          fi

          echo "access_token=$TOKEN" >> "$GITHUB_OUTPUT"

      - name: Probar acceso - listar workspaces
        shell: bash
        run: |
          echo "Listando workspaces visibles para el SP..."
          curl -s -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
            "https://api.fabric.microsoft.com/v1/workspaces" | jq .
      
      - name: Probar acceso - listar items del workspace
        shell: bash
        run: |
          echo "Listando items del workspace ${{ secrets.FABRIC_WORKSPACE_ID }}..."
          curl -s -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
            "https://api.fabric.microsoft.com/v1/workspaces/${{ secrets.FABRIC_WORKSPACE_ID }}/items" | jq .
      
      - name: Probar acceso-  obtener item específico (pipeline)
        shell: bash
        run: |
          echo "Obteniendo el item (pipeline) por ID..."
          curl -s -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
            "https://api.fabric.microsoft.com/v1/workspaces/${{ secrets.FABRIC_WORKSPACE_ID }}/items/${{ secrets.FABRIC_PIPELINE_ID }}" | jq .

      - name: Ejecutar Data Pipeline (job instance)
        shell: bash
        run: |
          set -e
          FILE="${{ steps.pick-file.outputs.file }}"
      
          # Si tu pipeline tiene un parámetro llamado "payload", dejamos tu JSON ahí.
          # Ajusta "payload" por el NOMBRE EXACTO del parámetro definido en tu pipeline.
          BODY=$(jq -n --slurpfile params "$FILE" \
            '{ 
               executionData: { 
                 # Opcional pero recomendable: el displayName del pipeline
                 pipelineName: "pl_get_data_github",
                 # Si tu pipeline no usa parámetros, elimina la línea de payload.
                 payload: $params[0]
               } 
             }')
      
          echo "Payload enviado a Fabric:"
          echo "$BODY" | jq
      
          RES=$(curl -s -w "\nHTTP_STATUS:%{http_code}\n" -X POST \
            -H "Authorization: Bearer ${{ steps.token.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            "https://api.fabric.microsoft.com/v1/workspaces/${{ secrets.FABRIC_WORKSPACE_ID }}/items/${{ secrets.FABRIC_PIPELINE_ID }}/jobs/instances?jobType=Pipeline")
      
          HTTP_STATUS=$(echo "$RES" | tr -d '\r' | sed -n 's/HTTP_STATUS://p')
          BODY_RES=$(echo "$RES" | sed '/HTTP_STATUS:/d')
      
          echo "Respuesta de Fabric (status $HTTP_STATUS):"
          echo "$BODY_RES" | jq . || echo "$BODY_RES"
      
          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "La API de Fabric devolvió error (HTTP $HTTP_STATUS)"; exit 1
          fi
      
          # Si quieres capturar el id de la instancia para hacer polling:
          INSTANCE_ID=$(echo "$BODY_RES" | jq -r '.id // .instanceId // empty')
          echo "instance_id=$INSTANCE_ID" >> "$GITHUB_OUTPUT"
